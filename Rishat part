import time
import json
import requests
import logging
from flask import Flask, request

"""
=====================
üìå Webex Timer Bot - Core Logic üìå
=====================

–≠—Ç–æ—Ç –º–æ–¥—É–ª—å —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—Å–Ω–æ–≤–Ω—É—é –ª–æ–≥–∏–∫—É —Ä–∞–±–æ—Ç—ã —Å API Webex
–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —Ç–∞–π–º–µ—Ä–∞.
"""

# Webex Bot Token (–∑–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π)
WEBEX_BOT_TOKEN = "N2NlMWM0ZTktODY4OS00MjM1LTg2YzMtYjc3NjhlZjIwNWRmOTcyMjYxYzMtZmE3_PE93_d84055ec-08e2-496f-a788-e38009e29164"
HEADERS = {"Authorization": f"Bearer {WEBEX_BOT_TOKEN}", "Content-Type": "application/json"}

app = Flask(__name__)

def get_message(message_id):
    """–ü–æ–ª—É—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ –µ–≥–æ ID"""
    url = f"https://webexapis.com/v1/messages/{message_id}"
    response = requests.get(url, headers=HEADERS)
    return response.json() if response.status_code == 200 else None

@app.route("/webhook", methods=["POST"])
def webhook():
    data = request.json
    if "data" in data and "id" in data["data"]:
        from maksat_branch import process_message
        process_message(data["data"]["id"])
    return "OK", 200

# –ü—Ä–æ—Å—Ç–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
def parse_timer(text):
    return {"30 —Å–µ–∫": 30, "1 –º–∏–Ω": 60, "5 –º–∏–Ω": 300}.get(text, 0)

# –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã —Ç–∞–π–º–µ—Ä–∞
def start_timer(user_id, seconds):
    if seconds <= 0:
        from maksat_branch import send_message
        send_message(user_id, "–û—à–∏–±–∫–∞: –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏.")
        return

    from maksat_branch import send_message
    send_message(user_id, f"–¢–∞–π–º–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ {seconds} —Å–µ–∫—É–Ω–¥...")
    time.sleep(seconds)
    send_message(user_id, "‚è∞ –í—Ä–µ–º—è –≤—ã—à–ª–æ!")

def send_message_to_maksat_branch(user_id, text):
    """–ü–µ—Ä–µ–¥–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –≤–µ—Ç–∫—É –ú–∞–∫—Å–∞—Ç–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏"""
    from maksat_branch import send_message
    send_message(user_id, text)

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=5000, debug=True)
